package main

import (
	"fmt"
	"math/rand"
	"strings"
	"time"

	// –ò–º–ø–æ—Ä—Ç –Ω–∞—à–∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–∞–∫–µ—Ç–æ–≤
	"ai_procure/models"
	"ai_procure/risk_analysis"
)

// –ò–º–∏—Ç–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö LLM (–ú–æ–¥—É–ª—å 2)
// –í —Ä–µ–∞–ª—å–Ω–æ–º MVP –∑–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ LLM API.
func mockLLMExtraction(documentText string) models.CompanyProfile {
	// –ò–º–∏—Ç–∞—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
	// –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞—Ä–∞–Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ "—Ä–∏—Å–∫–æ–≤—ã–µ" –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –ª–æ–≥–∏–∫–∏
	if strings.Contains(documentText, "–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è_–∫–æ–º–ø–∞–Ω–∏—è") {
		return models.CompanyProfile{
			Name:    "–¢–û–û –°–µ–º—å –ó–≤–µ–∑–¥",
			Address: "—É–ª. –î–æ—Å—Ç—ã–∫, 8/1", // –ò–º–∏—Ç–∞—Ü–∏—è –∞—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
			BIN_INN: "012345678901",
		}
	}
	return models.CompanyProfile{
		Name:    "–¢–û–û –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –†–µ—à–µ–Ω–∏—è",
		Address: "–≥. –ê—Å—Ç–∞–Ω–∞, —É–ª. –ö–µ–Ω–µ—Å–∞—Ä—ã, 1",
		BIN_INN: "111222333444",
	}
}

// –ò–º–∏—Ç–∞—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É–º–º—ã –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ LLM (–ú–æ–¥—É–ª—å 2)
func mockLLMPriceExtraction(documentText string) float64 {
	if strings.Contains(documentText, "–¥–æ—Ä–æ–≥–æ–π_—Ç–µ–Ω–¥–µ—Ä") {
		return 15000000.0 // –ò–º–∏—Ç–∞—Ü–∏—è –∞–Ω–æ–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–æ–π —Ü–µ–Ω—ã
	}
	return 4500000.0 // –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
}

// –ò–º–∏—Ç–∞—Ü–∏—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
func loadHistoricalData(subject string) []models.HistoryRecord {
	rand.Seed(time.Now().UnixNano())

	// –ë–∞–∑–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ RISK A (–ê—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å)
	history := []models.HistoryRecord{
		{
			Company: models.CompanyProfile{
				Name:    "–ê–û –°–µ–º—å –ó–≤–µ–∑–¥", // –û—á–µ–Ω—å –ø–æ—Ö–æ–∂–µ –Ω–∞ "–¢–û–û –°–µ–º—å –ó–≤–µ–∑–¥"
				Address: "—É–ª. –î–æ—Å—Ç—ã–∫, 8/1, –æ—Ñ–∏—Å 1",
				BIN_INN: "000000000000",
			},
			IsSuspicious:    true, // –ö–æ–º–ø–∞–Ω–∏—è —Å –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π
			ContractAmount:  1000000.0,
			ContractSubject: "–ü–æ—Å—Ç–∞–≤–∫–∞ –ü–û",
		},
		{
			Company: models.CompanyProfile{
				Name:    "–¢–û–û –ù–µ–∞—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ö–æ–º–ø–∞–Ω–∏—è",
				Address: "—É–ª. –ú–∞–Ω–≥–∏–ª–∏–∫ –ï–ª, 55",
				BIN_INN: "999888777666",
			},
			IsSuspicious:    false,
			ContractAmount:  5000000.0,
			ContractSubject: "–ü–æ—Å—Ç–∞–≤–∫–∞ –ü–û",
		},
	}

	// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ RISK B (–ê–Ω–æ–º–∞–ª–∏–∏ –¶–µ–Ω)
	// –°–æ–∑–¥–∞–µ–º —Ü–µ–Ω—ã, –≥–¥–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ª–µ–∂–∏—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 4-6 –º–ª–Ω
	for i := 0; i < 20; i++ {
		history = append(history, models.HistoryRecord{
			Company: models.CompanyProfile{
				Name: fmt.Sprintf("–ö–æ–º–ø–∞–Ω–∏—è %d", i),
			},
			ContractAmount:  4000000.0 + rand.Float64()*(2000000.0), // –¶–µ–Ω—ã –æ—Ç 4 –¥–æ 6 –º–ª–Ω
			ContractSubject: "–ü–æ—Å—Ç–∞–≤–∫–∞ –ü–û",
		})
	}
	return history
}

func main() {
	fmt.Println("ü§ñ AI-Procure Agent: –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–Ω–¥–µ—Ä–∞...")
	fmt.Println("-------------------------------------------------------")

	// --- 1. –ò–º–∏—Ç–∞—Ü–∏—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ LLM-–∏–∑–≤–ª–µ—á–µ–Ω–∏—è (–ú–æ–¥—É–ª—å 1 & 2) ---

	// –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–Ω–¥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–±–∞ —Ç–∏–ø–∞ —Ä–∏—Å–∫–∞
	rawTenderText := "–¢–µ–Ω–¥–µ—Ä –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É –ü–û. –£—á–∞—Å—Ç–Ω–∏–∫: –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è_–∫–æ–º–ø–∞–Ω–∏—è. –¶–µ–Ω–∞: –¥–æ—Ä–æ–≥–æ–π_—Ç–µ–Ω–¥–µ—Ä."

	tendererProfile := mockLLMExtraction(rawTenderText)
	tenderAmount := mockLLMPriceExtraction(rawTenderText)

	fmt.Printf("‚úÖ LLM –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –¢–µ–∫—É—â–∏–π —É—á–∞—Å—Ç–Ω–∏–∫: %s (%.2f KZT)\n", tendererProfile.Name, tenderAmount)

	// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞ "–ü–æ—Å—Ç–∞–≤–∫–∞ –ü–û"
	historicalData := loadHistoricalData("–ü–æ—Å—Ç–∞–≤–∫–∞ –ü–û")

	// --- 2. –ê–Ω–∞–ª–∏–∑ –†–∏—Å–∫–æ–≤ (–ú–æ–¥—É–ª—å 3) ---

	// A. –ê–Ω–∞–ª–∏–∑ –ê—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ (Risk A)
	affiliationResult := risk_analysis.CheckAffiliation(tendererProfile, historicalData)

	// B. –ê–Ω–∞–ª–∏–∑ –ê–Ω–æ–º–∞–ª–∏–π –¶–µ–Ω (Risk B)
	priceResult := risk_analysis.CheckPriceAnomaly(tenderAmount, historicalData)

	// --- 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∏–Ω–∞–ª—å–Ω–æ–≥–æ –û—Ç—á–µ—Ç–∞ MVP ---

	fmt.Println("\n## üìã –û—Ç—á–µ—Ç –æ–± –ê–Ω–∞–ª–∏–∑–µ –†–∏—Å–∫–æ–≤ (MVP)")
	fmt.Println("-------------------------------------------------------")

	// --- A. –°–≤–æ–¥–∫–∞ –†–∏—Å–∫–æ–≤ –ê—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ (Risk A) ---

	fmt.Println("1. –ê–Ω–∞–ª–∏–∑ –ê—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ (Risk A)")
	if affiliationResult.IsAffiliated {
		fmt.Printf("   üö® –†–ò–°–ö: –ê–§–§–ò–õ–ò–†–û–í–ê–ù–ù–û–°–¢–¨/–°–ì–û–í–û–† - –û–ë–ù–ê–†–£–ñ–ï–ù!\n")
		fmt.Printf("      –ü—Ä–∏—á–∏–Ω–∞: %s\n", affiliationResult.Reason)
		fmt.Printf("      –°—á–µ—Ç —Å—Ö–æ–¥—Å—Ç–≤–∞: %.2f%%\n", affiliationResult.Score*100)
	} else {
		fmt.Printf("   ‚úÖ –†–ò–°–ö: –ê—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å - –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. (%s)\n", affiliationResult.Reason)
	}

	// --- B. –°–≤–æ–¥–∫–∞ –†–∏—Å–∫–æ–≤ –¶–µ–Ω (Risk B) ---

	fmt.Println("\n2. –ê–Ω–∞–ª–∏–∑ –ê–Ω–æ–º–∞–ª–∏–π –¶–µ–Ω (Risk B)")
	if priceResult.IsAnomaly {
		fmt.Printf("   ‚ö† –†–ò–°–ö: –ê–ù–û–ú–ê–õ–¨–ù–ê–Ø –¶–ï–ù–ê - –û–ë–ù–ê–†–£–ñ–ï–ù!\n")
		fmt.Printf("      –ü—Ä–∏—á–∏–Ω–∞: %s\n", priceResult.Reason)
		fmt.Printf("      –í–µ—Ä—Ö–Ω—è—è/–ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ (1.5 IQR): %.2f KZT\n", priceResult.Boundary)
		fmt.Printf("      –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: %.2f KZT\n", tenderAmount)
	} else {
		fmt.Printf("   ‚úÖ –†–ò–°–ö: –ê–Ω–æ–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ - –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. (%s)\n", priceResult.Reason)
	}

	fmt.Println("\n-------------------------------------------------------")
	fmt.Println("üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø –ê–ì–ï–ù–¢–ê: –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω–æ–≥–æ¬†—Ç–µ–Ω–¥–µ—Ä–∞.")
}
